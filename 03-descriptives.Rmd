# Описатеьные статистики
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
```{r warning=FALSE, include=FALSE, message=FALSE}
library(knitr)
library(kableExtra)
library(dplyr)
library(readr)
library(fBasics)
library(formattable)
library(plotrix)
```

### О данных {-}
В датасете исправлены ошибки и сделаны en_названия регионов. Те full_table_7_04.csv финальный датасет со всем-всем + доп колонки с росстата. NA заменены на нули. Мое + Алексей. Надо объединить кодбук. Все преобразования датасета в файле scr1.R
```{r warning=FALSE,  include=FALSE, message=FALSE}
df <- read_csv("~/Desktop/Applied_Geography/rnf_model/grantbook/data/full_table_7_04.csv")
#write.csv(alexey_database, "alexey_database.csv",row.names = TRUE, fileEncoding = "UTF-8" )
```

### Описательные статистики {-}
```{r warning=FALSE}
df_cut_stat <- df %>% 
  select(35:40)
df_cut_stat[df_cut_stat==0] <- NA
J <- basicStats(df_cut_stat)
J <- data.frame(t(J))
formattable(J, digits = 2) %>% select(1:9)
#write.csv(J, "descr_stat.csv",row.names = TRUE, fileEncoding = "UTF-8" )
```

От 21 до 38 регионов не получают грантов РНФ вообще (за 2014-2019 гг). Медиана в разы меньше среднего + третий квантиль колеблется от 6 до 16 при максимуме от 134 до 827. Рапределие далеко от нормального и будет иметь очень длинный хвост. Очень неоднородное кол-во грантов по годам: в 2015 выдали 418 грантов, в 2019 -- 2096.

### Таблицы {-}

Уйдем от штук на доли, чтобы нивелировать сильный разброс в кол-ве выданных грантов по годам. 

Попробуем поймать таблицей какую-нибудь красивую тенденцию, например, поишем регионы, которые год от года увеличивают совою долю грантов.  

###### Дурацкая таблица: _доля грантов РНФ (от всех выданных грантов РНФ по стране в соответствующй год)_ {-}
```{r warning=FALSE}
# возвращаемся к df_cut_share
df_color <- df %>% 
  mutate(change2015 = sh_2015-sh_2014,
         change2016 = sh_2016-sh_2015,
         change2017 = sh_2017-sh_2016,
         change2018 = sh_2018-sh_2017,
         change2019 = sh_2019-sh_2018) %>% 
  mutate_if(is.numeric, round, digits = 5)

#write.csv(df_color, "df_color.csv",row.names = TRUE, fileEncoding = "UTF-8" )
```

```{r warning=FALSE}

g <- formattable(df_color, list(
  `sh_2015`= formatter("span", style = ~ style(color = ifelse(`sh_2015` >`sh_2014`, "green", "red")),
                    ~ icontext(ifelse(`sh_2015` >`sh_2014`,"arrow-up", "arrow-down"), `sh_2015`)),
  `sh_2016`= formatter("span", style = ~ style(color = ifelse(`sh_2016` >`sh_2015`, "green", "red")),
                       ~ icontext(ifelse(`sh_2016` >`sh_2015`,"arrow-up", "arrow-down"), `sh_2016`)),
  `sh_2017`= formatter("span", style = ~ style(color = ifelse(`sh_2017` >`sh_2016`, "green", "red")),
                       ~ icontext(ifelse(`sh_2017` >`sh_2016`,"arrow-up", "arrow-down"), `sh_2017`)),
  `sh_2018`= formatter("span", style = ~ style(color = ifelse(`sh_2018` >`sh_2017`, "green", "red")),
                       ~ icontext(ifelse(`sh_2018` >`sh_2017`,"arrow-up", "arrow-down"), `sh_2018`)),
  `sh_2019`= formatter("span", style = ~ style(color = ifelse(`sh_2019` >`sh_2018`, "green", "red")),
                       ~ icontext(ifelse(`sh_2019` >`sh_2018`,"arrow-up", "arrow-down"), `sh_2019`)))) %>%
  select(3, starts_with("sh_2")) 

as.datatable(g) # стрелочки пропали из за нее. 
```

sh_2014 не окрашен, так как цвет горорит об изменении к предыдущему году. Никакой супер интересной тенденции в табличке не видно, на первый взгляд все регионы теряют доли и прирастают име довольно хаотично. Ну кроме некоторых регионов, у которых стабильный 0. Их легко увидеть, если все столбики отсортировать "по возрастанию".

###### Таблица получше: _доля грантов РНФ в 2014-2016 (first_period) и в 2017-2019 (second_period) (от всех выданных грантов РНФ по стране в соответствующй период)_ {-}
```{r warning=FALSE, message=FALSE}
#colnames(df_color)

f <- formattable(df_color, list(
  `second_period`= formatter("span", style = ~ style(color = ifelse(`second_period` >`first_period`, "green", "red")),
                    ~ icontext(ifelse(`second_period` >`first_period`,"arrow-up", "arrow-down"), `second_period`)))) %>%
  select(3, 68, 69) 
as.datatable(f)

```

У _first_period_ и _second_period_ коэфицент корреляции что-то около 0,85-0,9, то есть, если регион получал гранты в 2014-2016 году, то он будет получать примерно на таком же уровне в 2017-2019. И наоборот, те у кого грантов не было, во втором периоде чуда не случится. (РАЗБЕРИСЬ С КОЭФИЦЕНТАМИ КОРРЕЛЯЦИИ, КАКОЙ ИЗ НИХ НУЖЕН ПРИ ТАКОМ РАСПРЕДЕЛЕНИИ)

### Боксплоты {-}

Хочется посмотреть выбросы, причем поймать как будут сжиматься медиана и максимальное занчаение выданных грантов когда мы будем эти выбросы постепенно убирать.

```{r warning=FALSE}
# long 85 * 6 = 510
library(tidyr)

data_long <- df %>% select(3, region_id,starts_with("rnf20"))
data_long <- gather(data_long, condition, measurement, rnf2014:rnf2019, factor_key=TRUE)
data_long <- data_long %>% mutate(condition = gsub("[^0-9.-]+", "", condition))
data_long <- data_long %>%
  mutate(measurement = if_else(is.na(measurement), 0, measurement))

data_long <- as.data.frame(data_long)

data_long_cut_11_12_38 <- data_long %>% 
  dplyr::filter(region_id != 11) %>% 
  dplyr::filter(region_id != 12) %>% 
  dplyr::filter(region_id != 38) 

data_long_cut_11_12_38_plus <- data_long_cut_11_12_38 %>% 
  dplyr::filter(region_id != 33) %>% 
  dplyr::filter(region_id != 36) %>% 
  dplyr::filter(region_id != 60) %>% 
  dplyr::filter(region_id != 68) %>% 
  dplyr::filter(region_id != 73) 


par(mfcol=c(2,2), oma=c(0,0,2,0))
boxplot(data_long$measurement ~ data_long$region_id,
        xlab = "Все регионы",
        ylab = "Гранты в шт") # 11, 12, 38
boxplot(data_long_cut_11_12_38$measurement ~ data_long_cut_11_12_38$region_id,
        xlab = "Без Топ-3",
        ylab = "Гранты в шт")  # 33 36 60 68 73
boxplot(data_long_cut_11_12_38_plus$measurement ~ data_long_cut_11_12_38_plus$region_id,
        xlab = "Без ТОП-8",
        ylab = "Гранты в шт")
mtext("Распределение грантов РНФ по регионам России за 2014-2019", line=0, side=3, outer=TRUE, cex=-10)

```
Тут у нас уже боксплоты по панели 2014-2019. Ось _x_- номер региона, на первом графике сильно выбивабтся Москва(11), Санкт-Петербург(12) и Новосибирская обл.(38). Например, Москва за 2014-2019 год имела максимальное кол-во грантов ~ 600 шт (по боксплоту плохо видно точное число), при этом медиана у Москвы была за эти годы примерно на уровне ~ 400 грантов. Если мы отрежим 

Топ-3 регона, то получим рисунок "Без Топ-3" у которого шкала оси _y_ гораздо короче, и тут у нас появлось пять новых "регинов-выбросов". Убираем их и получаем, график "Без Топ-8", где 77 регионв вполне себе уживаются в шкале до ~30 грантов. Посмотрим его поближе. 

```{r warning=FALSE}
boxplot(data_long_cut_11_12_38_plus$measurement ~ data_long_cut_11_12_38_plus$region_id,
        xlab = "Без ТОП-8",
        ylab = "Гранты в шт")
```
Вот здесь вполне мы видим какое-никакое разнообразие. 

Далее идет скрипт в scr1.R со слов стрчки 210 # добавим доп таболицу с росстата 





