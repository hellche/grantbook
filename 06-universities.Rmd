# Университеты и их гранты

```{r warning=FALSE, include=FALSE, message=FALSE}
library(knitr)
library(kableExtra)
library(dplyr)
library(readr)
library(fBasics)
library(formattable)
library(plotrix)
library(tidyr)
library(readxl)
```


Соединим Дашин датасет по РИНЦу и данные Алексея по грантам универов.

```{r warning=FALSE, message=FALSE}
df <- read_csv("data/full_11_May_version.csv")
#colnames(df)
```

У нас **7610 грантов** за 2014-2019 годы. 

В РИНЦе нет 23 организации, которые получали гранты РНФ (всего 33 гратнта из 7610 мы далее выбросим из анализа). 

Что мы хотимс посмотреть:

1. Топ организаций по грантам

2. Топ регионов по грантам с информацией о кол-ве организваций

3. Топ универов по Доле классных публикаций 

4. Топ регионов по доле классных публикаций

5. ~~3 и 4 (для организаций > 25 Скопусовских/WoS за 5 лет)~~

***

##### Таблица 1: Топ организаций по грантам  {-}

```{r warning=FALSE, message=FALSE}

rf <- df %>% mutate(Univ = gsub('"', '', Univ)) %>% group_by(id,Univ) %>% count()
colnames(rf)[1] <- "id по РИНЦ" 
rf <- formattable(rf)
as.datatable(rf)
```

***

##### Таблица 2: Топ регионов по грантам с информацией о кол-ве организваций  {-}

```{r warning=FALSE, message=FALSE}

rf <- df %>% group_by(Регион, id) %>% 
  summarise(grants_count = length(Регион)) %>% group_by(Регион) %>% 
  summarise(uni_count = length(id), grants_count = sum(grants_count)) %>% 
  mutate(`грантов на организацию` = grants_count/uni_count)

colnames(rf)[3] <- "всего грантов"
colnames(rf)[2] <- "всего организаций"

rf <- formattable(rf)
as.datatable(rf)


```

***

##### Таблица 3: Топ универов по Доле классных публикаций  {-}

Посчитаем <span style="background-color: #ffff99">долю (%) публикаций Scopus и Web of Science от общего числа публикаций **в организации**</span>  по такой формуле:

$$ \frac{sco\_wos\_5}{elab\_5 +1} * 100$$
где,

$sco\_wos\_5$ -	число статей в журналах, входящих в Web of Science или Scopus, за 5 лет (переменная в кодбуке -- _N_pub_WOSSC5_)

$elab\_5$ - число публикаций на elibrary, за 5 лет (переменная в кодбуке -- _N_elibrary5_)

Единицу в знаменатель мы добавили, чтобы не отрезать организации, у которых 0 публикаций на elibrary.ru за 5 лет.


```{r warning=FALSE, message=FALSE}
# код для убирания процентов в скобках
nl <- df %>% 
  mutate(N_pub_WOSSC5_persent = gsub("[\\(\\)]", "", regmatches(N_pub_WOSSC5, gregexpr("\\(.*?\\)", N_pub_WOSSC5)))) %>% 
  mutate(N_pub_WOSSC5_persent = gsub("%", "", N_pub_WOSSC5_persent)) %>% 
  mutate(N_pub_WOSSC5_persent = gsub(",", ".", N_pub_WOSSC5_persent)) %>% 
  mutate(N_pub_WOSSC5 = gsub("\\(.*","",N_pub_WOSSC5)) %>% 
  mutate(N_pub_WOSSC5 = as.numeric(N_pub_WOSSC5),
         N_pub_WOSSC5_persent = as.numeric(as.character(N_pub_WOSSC5_persent))) %>% 
  mutate(Univ = gsub('"', '', Univ))


#nl <- nl %>% dplyr::filter(N_pub_WOSSC5 > 24) 

```


```{r warning=FALSE, message=FALSE}
options(digits = 3)
h <- data.table::setDT(nl)[ , list(`доля классных публикаций` = 100*(N_pub_WOSSC5/(N_elibrary5+1)),
                                   count_of_grants = .N), by = .(Univ)]
h <- h %>% distinct(Univ, .keep_all = TRUE)
h <- formattable(h)
as.datatable(h)

```

***

Теперь агрегируем эти данные по универам, чтобы получить данные по регионам. 

КАК МЫ АГРЕГИРУЕМ: агрегируем по грантам, а не по организациям. Например, в Воронежской области на 4 организации приходится 35 грантов. Причем одна организация с самым высоким показателем класнных публикаций получила большую часть из этих 35 грантов. Таким образом,  самое большое значение (максимум) еще и встало на место медианы. 


##### Таблица 4: Топ регионов по доле классных публикаций  {-}

Тут мы делаем рейтинг регионов ТОЛЬКО по организациям, которые хоть раз получали грант РНФ. 

```{r warning=FALSE, message=FALSE}
rg <- nl %>% mutate(share_good = 100*(N_pub_WOSSC5/(N_elibrary5+1))) %>% 
  group_by(Регион) %>%
  summarise(mean = mean(share_good),
            median = median(share_good),
            min = min(share_good),
            max = max(share_good),
            `всего грантов` = length(share_good))
ra <- rf %>% dplyr::select(1,2,4)
rg <- left_join(rg,ra, by = "Регион" )

rg <- formattable(rg)
as.datatable(rg)
```


поиск ненайденных 52 штук

```{r}
#library(readr)
#df52 <- read_delim("data/unknownKnown/топ ненайденых универов-Tаблица 1.csv", 
#    ";", escape_double = FALSE, trim_ws = TRUE)

#df52 <- df52 %>% select(1,3) 
#colnames(df52)[2] <- "id"
#df52 <- df52 %>% filter(id > 0) 
#joined_final <- read_csv("data/joined_final.csv")
#full_final_joined <- left_join(joined_final, df52, by = "Univ")
#write.csv(full_final_joined, "full_final_joined.csv", fileEncoding = "UTF-8")
#full_final_joined <- full_final_joined %>% select(-1,-2,-3,-12,-13)
#dt <- left_join(full_final_joined, universities_full_and_russian_universities, by = "id")
#d1 <- d1 %>% group_by(Univ) %>% count()
#d2 <- dt %>% filter(is.na(page)) %>% group_by(Univ) %>% count()
#dt <- dt %>% filter(!is.na(page))
#write.csv(dt, "full_11_May_version.csv", fileEncoding = "UTF-8")
```


```{r}
#library(readr)
#joined_final <- read_csv("data/joined_final.csv")
#joined_final_clean <- read_csv("data/joined_final_clean.csv")

#unknown <- joined_final %>% filter(is.na(id)) %>% group_by(Univ) %>% count()
#unknown2 <- joined_final %>% filter(is.na(id)) 

#write.csv(unknown, "unknown.csv", fileEncoding = "UTF-8")
#write.csv(unknown2, "unknown2.csv", fileEncoding = "UTF-8")
```
 
